<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="estilos.css">
    <title>Formulario</title>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
             <div class="header-text">BP | DESARROLLO - SECTOR PUBLICO</div>
        </div>
    </header>
    
      <!-- Contenido principal de la página -->
    <main class="container">
        <!-- Sección de introducción con título y subtítulo -->
        <div class="page-intro">
            <h1 id="endpoint-titulo">Detalle Lotes 650</h1>
        </div>
    
        <div class="form-container">
            <form id="consulta-form" novalidate></form>
            <div class="button-container">
                <button id="exportar-btn" onclick="exportarExcel()" disabled>Exportar a Excel</button>
                <button onclick="location.href='index.html'">Volver</button>
            </div>
            <div id="spinner">⏳ Consultando...</div>
        </div>
    </main>

    <div id="tabla-wrapper" class="grid-wrapper" style="display:none">
        <div id="total-registros" class="total-registros"></div>
        <div id="tabla-container"></div>
    </div>

    <div class="pagination" id="pagination" style="display:none">
        <button id="prev-btn">Anterior</button>
        <span id="pagina-actual" style="margin: 0 10px;"></span>
        <button id="next-btn">Siguiente</button>
    </div>

    <script>
        let currentPage = 1;
        let pageSize = 20;
        let paginatedData = [];
        let ordenActual = null;
        let ordenAscendente = true;

        function mostrarPagina() {
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = paginatedData.slice(start, end);

            if (!pageData.length) {
                document.getElementById('tabla-container').innerHTML = '<p>No hay datos para mostrar.</p>';
                return;
            }

            const headers = Object.keys(pageData[0]);
            let table = '<table><thead><tr>';

            headers.forEach(key => {
                const flecha = (ordenActual === key) ? (ordenAscendente ? '▲' : '▼') : '⇅';
                table += `<th class="sortable" onclick="ordenarPor('${key}')">${key.toUpperCase()} <span>${flecha}</span></th>`;
            });

            table += '</tr></thead><tbody>';

            pageData.forEach(row => {
                table += '<tr>';
                headers.forEach(key => {
                    const val = row[key] ?? "";
                    if (key.toLowerCase().startsWith('imp_') && !isNaN(val)) {
                        const num = parseFloat(val);
                        const cellContent = num.toLocaleString('es-AR', {
                            style: 'currency',
                            currency: 'ARS',
                            minimumFractionDigits: 2
                        });
                        table += `<td class="importe">${cellContent}</td>`;
                    } else {
                        table += `<td>${val}</td>`;
                    }
                });
                table += '</tr>';
            });

            table += '</tbody></table>';
            document.getElementById("tabla-wrapper").style.display = "block";
            document.getElementById('tabla-container').innerHTML = table;

            mostrarPaginacion();
        }

        function ordenarPor(key) {
            if (ordenActual === key) {
                ordenAscendente = !ordenAscendente;
            } else {
                ordenActual = key;
                ordenAscendente = true;
            }
            paginatedData.sort((a, b) => {
                if (a[key] < b[key]) return ordenAscendente ? -1 : 1;
                if (a[key] > b[key]) return ordenAscendente ? 1 : -1;
                return 0;
            });
            mostrarPagina();
        }

        document.getElementById('prev-btn').onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                mostrarPagina();
            }
        };

        document.getElementById('next-btn').onclick = () => {
            const totalPages = Math.ceil(paginatedData.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                mostrarPagina();
            }
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco Provincia - Consultas Dinámicas</title>
    <!-- Google Fonts: Poppins para una tipografía moderna y legible -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="estilos2.css">
</head>
<body>
    <header>
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%230A6847' d='M12 2L3 7v14h18V7L12 2zm0 2.25L19 7.42V8H5v-.58l7-5.17zM5 10h14v9H5v-9zm2 2v5h2v-5H7zm4 0v5h2v-5h-2zm4 0v5h2v-5h-2z'/></svg>" alt="Logo Banco" class="header-logo">
        <div class="header-text">DESARROLLO - SECTOR PUBLICO</div>
    </header>
    <div class="green-line"></div>
    
    <div class="container">
        <h1 id="endpoint-titulo">Cargando...</h1>
        <div class="gray-line"></div>
        
        <div id="errorMsg"></div>

        <div class="form-container">
            <form id="consulta-form" novalidate></form>
            <div class="button-container">
                <button id="consultar-btn" class="btn btn-primary">Consultar</button>
                <button id="exportar-btn" class="btn btn-secondary" disabled>Exportar a Excel</button>
                <button id="volver-btn" class="btn btn-outline">Volver</button>
            </div>
            <div id="spinner">⏳ Consultando...</div>
        </div> 

        <div id="tabla-wrapper">
            <div id="total-registros" class="total-registros"></div>
            <div id="tabla-container"></div>
            <div class="pagination" id="pagination">
                <button id="prev-btn" class="btn btn-primary">Anterior</button>
                <span id="pagina-actual" style="margin: 0 15px; font-weight: 600;"></span>
                <button id="next-btn" class="btn btn-primary">Siguiente</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let currentPage = 1;
        let pageSize = 10;
        let allData = [];
        let parametrosDelEndpoint = [];

        // --- Referencias a elementos del DOM ---
        const endpointTitulo = document.getElementById('endpoint-titulo');
        const consultaForm = document.getElementById('consulta-form');
        const consultarBtn = document.getElementById('consultar-btn');
        const exportarBtn = document.getElementById('exportar-btn');
        const volverBtn = document.getElementById('volver-btn');
        const spinner = document.getElementById('spinner');
        const tablaWrapper = document.getElementById('tabla-wrapper');
        const tablaContainer = document.getElementById('tabla-container');
        const totalRegistrosDiv = document.getElementById('total-registros');
        const paginationControls = document.getElementById('pagination');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const paginaActualSpan = document.getElementById('pagina-actual');

        // --- Configuración (reemplaza la carga de config.json) ---
        const config = {
          "titulo": "API de Consultas DW",
          "grupos": [
            {
              "nombre": "Transferencias 650",
              "endpoints": [
                {
                  "nombre": "Lotes 650",
                  "path": "Lotes650",
                  "parametros": [
                    { "nombre": "cod_ordenante", "label": "Código de Ordenante: ", "tipo": "str" },
                    { "nombre": "fec_ini_pago", "label": "Fecha Desde: ", "tipo": "date" },
                    { "nombre": "fec_fin_pago", "label": "Fecha Hasta: ", "tipo": "date" }
                  ]
                },
                {
                  "nombre": "Detalle Lotes 650",
                  "path": "DetLote650",
                  "parametros": [
                    { "nombre": "cod_ordenante", "label": "Código de Ordenante: ", "tipo": "str" },
                    { "nombre": "fec_ini_pago", "label": "Fecha Desde: ", "tipo": "date" },
                    { "nombre": "fec_fin_pago", "label": "Fecha Hasta: ", "tipo": "date" }
                  ]
                },
                {
                  "nombre": "Productos 650 Vigentes",
                  "path": "Prod650Vig",
                  "parametros": [
                    { "nombre": "cuit", "label": "CUIT", "tipo": "int" }
                  ]
                }
              ]
            },
            {
              "nombre": "Rendiciones",
              "endpoints": [
                {
                  "nombre": "Rendiciones Entes Públicos/Privados",
                  "path": "Rendiciones/Entes",
                  "parametros": [
                    { "nombre": "cod_convenio", "label": "Código Ente", "tipo": "int" },
                    { "nombre": "cod_sub_convenio", "label": "Código Sub-Ente" , "tipo": "int" },
                    { "nombre": "fec_ini_rend", "label": "Fecha Rendición Desde", "tipo": "date" },
                    { "nombre": "fec_fin_rend", "label": "Fecha Rendición Hasta", "tipo": "date" },
                    { "nombre": "cod_ubicacion", "label": "Código Sucursal", "tipo": "int", "opcional": true }
                  ]
                }
              ]
            },
            {
              "nombre": "Entidades",
              "endpoints": [
                {
                  "nombre": "Entes Publicos/Privados",
                  "path": "Entidades/EntPubPriv",
                  "parametros": []
                }
              ]
            }
          ]
        };

        // --- Lógica de Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const endpointName = urlParams.get('endpoint') || 'DetLote650'; // Default para demo

            const grupo = config.grupos.find(g => g.endpoints.some(e => e.path === endpointName));
            const endpoint = grupo ? grupo.endpoints.find(e => e.path === endpointName) : null;

            if (!endpoint) {
                endpointTitulo.textContent = 'Error: Endpoint no encontrado';
                return;
            }

            endpointTitulo.textContent = endpoint.nombre;
            parametrosDelEndpoint = endpoint.parametros; // Guardar parámetros para validación
            createFormFields(endpoint.parametros);

            // Asignar eventos a los botones
            consultarBtn.addEventListener('click', () => consultar(endpoint.path));
            exportarBtn.addEventListener('click', exportarExcel);
            volverBtn.addEventListener('click', () => { location.href = 'index.html'; });
            prevBtn.addEventListener('click', () => changePage(-1));
            nextBtn.addEventListener('click', () => changePage(1));
        });

        function createFormFields(parametros) {
            consultaForm.innerHTML = ''; // Limpiar formulario
            parametros.forEach(param => {
                const group = document.createElement('div');
                group.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = param.label;
                label.setAttribute('for', param.nombre);

                const input = document.createElement('input');
                input.id = param.nombre;
                input.name = param.nombre;
                
                if (param.tipo === 'date') {
                    input.type = 'date';
                } else if (param.tipo === 'int') {
                    input.type = 'number';
                } else {
                    input.type = 'text';
                }

                if (!param.opcional) {
                    label.textContent += ' *'; // Indicador visual de campo obligatorio
                }

                group.appendChild(label);
                group.appendChild(input);
                consultaForm.appendChild(group);
            });
        }
        
        // --- Lógica de Consulta y Validación ---
        function consultar(path) {
            ocultarError();
            if (!validarFormulario()) {
                return;
            }
            
            // Mostrar spinner y preparar UI
            spinner.style.display = 'block';
            exportarBtn.disabled = true;
            tablaWrapper.style.display = 'none';
            tablaContainer.innerHTML = "";

            // Simulación de llamada a API
            setTimeout(() => {
                spinner.style.display = 'none';
                allData = generateSimulatedData(); // Usar datos simulados

                if (!allData || allData.length === 0) {
                    tablaContainer.innerHTML = '<p style="text-align: center;">No se encontraron resultados.</p>';
                    tablaWrapper.style.display = 'block';
                    return;
                }

                exportarBtn.disabled = false;
                totalRegistrosDiv.textContent = `TOTAL DE REGISTROS: ${allData.length}`;
                currentPage = 1;
                displayPage();
                tablaWrapper.style.display = 'block';
                paginationControls.style.display = 'flex';
            }, 1000);
        }

        function validarFormulario() {
            for (const param of parametrosDelEndpoint) {
                const input = document.getElementById(param.nombre);
                const valor = input.value.trim();

                if (!param.opcional && valor === "") {
                    mostrarError(`El campo "${param.label.replace(':','')}" es obligatorio.`);
                    input.focus();
                    return false;
                }

                if (valor !== "") {
                    if (param.tipo === "int" && !/^\d+$/.test(valor)) {
                        mostrarError(`El campo "${param.label.replace(':','')}" debe ser un número entero.`);
                        input.focus();
                        return false;
                    }
                }
            }
            return true;
        }

        function mostrarError(msg) {
            const div = document.getElementById("errorMsg");
            div.textContent = msg;
            div.style.display = "block";
        }

        function ocultarError() {
            document.getElementById("errorMsg").style.display = "none";
        }
        
        // --- Lógica de Tabla y Paginación ---
        function displayPage() {
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = allData.slice(start, end);

            tablaContainer.innerHTML = createTableHTML(pageData);
            updatePaginationInfo();
        }
        
        function createTableHTML(data) {
            if (!data.length) return "";

            const headers = Object.keys(data[0]);
            let table = '<table><thead><tr>';
            headers.forEach(key => table += `<th>${key.replace(/_/g, ' ')}</th>`);
            table += '</tr></thead><tbody>';

            data.forEach(row => {
                table += '<tr>';
                headers.forEach(key => {
                    const val = row[key] ?? "";
                    let cellContent = val;
                    let cellClass = '';
                    
                    if ((key.toLowerCase().startsWith('imp_') || key.toLowerCase().includes('monto')) && !isNaN(val)) {
                        cellContent = parseFloat(val).toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
                        cellClass = 'importe';
                    }
                    table += `<td class="${cellClass}">${cellContent}</td>`;
                });
                table += '</tr>';
            });

            return table + '</tbody></table>';
        }

        function updatePaginationInfo() {
            const totalPages = Math.ceil(allData.length / pageSize);
            paginaActualSpan.textContent = `Página ${currentPage} de ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            paginationControls.style.display = totalPages > 1 ? 'flex' : 'none';
        }
        
        function changePage(direction) {
            const totalPages = Math.ceil(allData.length / pageSize);
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayPage();
            }
        }
        
        // --- Funcionalidad Extra ---
        function exportarExcel() {
            if (!allData.length) return;

            const ws = XLSX.utils.json_to_sheet(allData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Resultados");
            
            const filename = `${endpointTitulo.textContent.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function generateSimulatedData() {
            // Genera datos de ejemplo para la demo
            const sampleData = [];
            for (let i = 1; i <= 35; i++) {
                sampleData.push({
                    "ID_TRANSACCION": 10000 + i,
                    "FECHA_PAGO": `2024-05-${String(i % 30 + 1).padStart(2,'0')}`,
                    "MONTO_PAGO": (Math.random() * 5000 + 500).toFixed(2),
                    "CONCEPTO": "Pago a Proveedor " + i,
                    "CLIENTE": "Empresa " + String.fromCharCode(65 + i % 26),
                    "ESTADO": i % 4 === 0 ? "Pendiente" : "Pagado"
                });
            }
            return sampleData;
        }

    </script>
</body>
</html>
